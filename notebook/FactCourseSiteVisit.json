{
	"name": "FactCourseSiteVisit",
	"properties": {
		"nbformat": 4,
		"nbformat_minor": 2,
		"bigDataPool": {
			"referenceName": "batched",
			"type": "BigDataPoolReference"
		},
		"sessionProperties": {
			"driverMemory": "28g",
			"driverCores": 4,
			"executorMemory": "28g",
			"executorCores": 4,
			"numExecutors": 2,
			"conf": {
				"spark.dynamicAllocation.enabled": "false",
				"spark.dynamicAllocation.minExecutors": "2",
				"spark.dynamicAllocation.maxExecutors": "2"
			}
		},
		"metadata": {
			"saveOutput": true,
			"synapse_widget": {
				"version": "0.1",
				"state": {
					"8caa181f-f090-47c9-8ca2-a27f2ab604ee": {
						"type": "Synapse.DataFrame",
						"sync_state": {
							"table": {
								"rows": [
									{
										"0": "Lesson",
										"1": "Lesson",
										"2": "59283"
									},
									{
										"0": "Other",
										"1": "System",
										"2": "9884"
									},
									{
										"0": "Other",
										"1": "Wiki",
										"2": "1"
									},
									{
										"0": "Assignment",
										"1": "Assignment",
										"2": "1047252"
									},
									{
										"0": "Interactive Content",
										"1": "H5P",
										"2": "452836"
									},
									{
										"0": "Other",
										"1": "Choice",
										"2": "114"
									},
									{
										"0": "Database",
										"1": "Database",
										"2": "15911"
									},
									{
										"0": "Other",
										"1": "Quiz",
										"2": "10699"
									},
									{
										"0": "Assignment",
										"1": "UniSA Media Library Video Assignment",
										"2": "142"
									},
									{
										"0": "Other",
										"1": "Lightbox Gallery",
										"2": "23"
									},
									{
										"0": "Quiz",
										"1": "Quiz",
										"2": "922316"
									},
									{
										"0": "Course",
										"1": "Overview report",
										"2": "268"
									},
									{
										"0": "Course",
										"1": "Wiki",
										"2": "4"
									},
									{
										"0": "Course",
										"1": "Feedback",
										"2": "40"
									},
									{
										"0": "Other",
										"1": "Dialogue",
										"2": "2"
									},
									{
										"0": "File",
										"1": "File",
										"2": "520277"
									},
									{
										"0": "Course",
										"1": "Grader report",
										"2": "10912"
									},
									{
										"0": "Folder",
										"1": "System",
										"2": "2559"
									},
									{
										"0": "Course",
										"1": "Course participation",
										"2": "551"
									},
									{
										"0": "Course",
										"1": "Plain text file",
										"2": "7"
									},
									{
										"0": "Group self-selection",
										"1": "System",
										"2": "77"
									},
									{
										"0": "Course",
										"1": "URL",
										"2": "1"
									},
									{
										"0": "Course",
										"1": "Extensions",
										"2": "63734"
									},
									{
										"0": "Other",
										"1": "Forum",
										"2": "4563"
									},
									{
										"0": "Book",
										"1": "Book printing",
										"2": "10"
									},
									{
										"0": "Course",
										"1": "Glossary",
										"2": "2"
									},
									{
										"0": "Assignment",
										"1": "Mahara portfolio",
										"2": "79"
									},
									{
										"0": "Other",
										"1": "Folder",
										"2": "1061"
									},
									{
										"0": "Other",
										"1": "File",
										"2": "3261"
									},
									{
										"0": "Other",
										"1": "Page",
										"2": "1644"
									},
									{
										"0": "Other",
										"1": "Assignment",
										"2": "1295"
									},
									{
										"0": "External tool",
										"1": "System",
										"2": "144"
									},
									{
										"0": "Label",
										"1": "{\"$numberDouble\":\"NaN\"}",
										"2": "206"
									},
									{
										"0": "SCORM package",
										"1": "SCORM package",
										"2": "1240"
									},
									{
										"0": "Other",
										"1": "Book printing",
										"2": "2"
									},
									{
										"0": "Quiz",
										"1": "System",
										"2": "17137"
									},
									{
										"0": "Workshop",
										"1": "System",
										"2": "795"
									},
									{
										"0": "Course",
										"1": "Assignment",
										"2": "96089"
									},
									{
										"0": "Scheduler",
										"1": "System",
										"2": "229"
									},
									{
										"0": "Course",
										"1": "System",
										"2": "5365096"
									},
									{
										"0": "Other",
										"1": "H5P",
										"2": "1629"
									},
									{
										"0": "Course",
										"1": "Live logs",
										"2": "149"
									},
									{
										"0": "Other",
										"1": "Group self-selection",
										"2": "3"
									},
									{
										"0": "Course",
										"1": "Choice",
										"2": "4"
									},
									{
										"0": "UniSA Learning Progress",
										"1": "System",
										"2": "9356"
									},
									{
										"0": "Other",
										"1": "UniSA Media Library",
										"2": "6"
									},
									{
										"0": "Zoom meeting",
										"1": "Zoom meeting",
										"2": "29663"
									},
									{
										"0": "Page",
										"1": "Page",
										"2": "123383"
									},
									{
										"0": "Chat",
										"1": "System",
										"2": "29"
									},
									{
										"0": "Other",
										"1": "Feedback",
										"2": "19"
									},
									{
										"0": "Assignment",
										"1": "System",
										"2": "31741"
									},
									{
										"0": "Group self-selection",
										"1": "Group self-selection",
										"2": "5043"
									},
									{
										"0": "URL",
										"1": "URL",
										"2": "63303"
									},
									{
										"0": "External tool",
										"1": "External tool",
										"2": "2454"
									},
									{
										"0": "Other",
										"1": "URL",
										"2": "876"
									},
									{
										"0": "UniSA Media Library",
										"1": "System",
										"2": "3"
									},
									{
										"0": "Other",
										"1": "File submissions",
										"2": "110"
									},
									{
										"0": "Other",
										"1": "Survey",
										"2": "15"
									},
									{
										"0": "Other",
										"1": "Lesson",
										"2": "28"
									},
									{
										"0": "Course",
										"1": "Lesson",
										"2": "7"
									},
									{
										"0": "Course",
										"1": "Recycle bin",
										"2": "9296"
									},
									{
										"0": "Chat",
										"1": "Chat",
										"2": "2490"
									},
									{
										"0": "Scheduler",
										"1": "Scheduler",
										"2": "21694"
									},
									{
										"0": "Course",
										"1": "Single view",
										"2": "1095"
									},
									{
										"0": "Course",
										"1": "UniSA Media Library",
										"2": "5"
									},
									{
										"0": "Feedback",
										"1": "Feedback",
										"2": "8558"
									},
									{
										"0": "Choice",
										"1": "System",
										"2": "771"
									},
									{
										"0": "Lesson",
										"1": "System",
										"2": "227"
									},
									{
										"0": "Course",
										"1": "OpenDocument spreadsheet",
										"2": "524"
									},
									{
										"0": "Book",
										"1": "System",
										"2": "335"
									},
									{
										"0": "Course",
										"1": "Grade history",
										"2": "8"
									},
									{
										"0": "Course",
										"1": "Database",
										"2": "3"
									},
									{
										"0": "Choice",
										"1": "Choice",
										"2": "10505"
									},
									{
										"0": "Dialogue",
										"1": "Dialogue",
										"2": "11966"
									},
									{
										"0": "Assignment",
										"1": "Online text submissions",
										"2": "4002"
									},
									{
										"0": "Course",
										"1": "Forum",
										"2": "79099"
									},
									{
										"0": "Interactive Content",
										"1": "System",
										"2": "6768"
									},
									{
										"0": "Course",
										"1": "External tool",
										"2": "10"
									},
									{
										"0": "Other",
										"1": "External tool",
										"2": "23"
									},
									{
										"0": "Other",
										"1": "Book",
										"2": "79"
									},
									{
										"0": "Course",
										"1": "H5P",
										"2": "37"
									},
									{
										"0": "Other",
										"1": "Database",
										"2": "115"
									},
									{
										"0": "Other",
										"1": "Scheduler",
										"2": "168"
									},
									{
										"0": "Other",
										"1": "Workshop",
										"2": "7"
									},
									{
										"0": "Course",
										"1": "File",
										"2": "1"
									},
									{
										"0": "Feedback",
										"1": "System",
										"2": "3186"
									},
									{
										"0": "Glossary",
										"1": "System",
										"2": "46"
									},
									{
										"0": "File",
										"1": "System",
										"2": "75654"
									},
									{
										"0": "Assignment",
										"1": "Submission comments",
										"2": "1323"
									},
									{
										"0": "Folder",
										"1": "Folder",
										"2": "78808"
									},
									{
										"0": "Other",
										"1": "Zoom meeting",
										"2": "208"
									},
									{
										"0": "Other",
										"1": "Submission comments",
										"2": "1"
									},
									{
										"0": "Other",
										"1": "SCORM package",
										"2": "3"
									},
									{
										"0": "Forum",
										"1": "Forum summary report",
										"2": "2"
									},
									{
										"0": "Course",
										"1": "Quiz",
										"2": "33297"
									},
									{
										"0": "Course",
										"1": "Scheduler",
										"2": "1"
									},
									{
										"0": "SCORM package",
										"1": "System",
										"2": "306"
									},
									{
										"0": "Page",
										"1": "System",
										"2": "13099"
									},
									{
										"0": "Course",
										"1": "Workshop",
										"2": "10"
									},
									{
										"0": "Label",
										"1": "System",
										"2": "125797"
									},
									{
										"0": "Assignment",
										"1": "File submissions",
										"2": "71266"
									},
									{
										"0": "Wiki",
										"1": "System",
										"2": "263"
									},
									{
										"0": "Workshop",
										"1": "Workshop",
										"2": "13631"
									},
									{
										"0": "Course",
										"1": "Activity report",
										"2": "233"
									},
									{
										"0": "URL",
										"1": "System",
										"2": "5107"
									},
									{
										"0": "Course",
										"1": "Logs",
										"2": "3119"
									},
									{
										"0": "Book",
										"1": "Book",
										"2": "10826"
									},
									{
										"0": "Dialogue",
										"1": "System",
										"2": "130"
									},
									{
										"0": "Course",
										"1": "Zoom meeting",
										"2": "1421"
									},
									{
										"0": "UniSA Media Library",
										"1": "UniSA Media Library",
										"2": "4"
									},
									{
										"0": "Glossary",
										"1": "Glossary",
										"2": "3196"
									},
									{
										"0": "Forum",
										"1": "Forum",
										"2": "2196158"
									},
									{
										"0": "Database",
										"1": "System",
										"2": "1786"
									},
									{
										"0": "Course",
										"1": "Excel spreadsheet",
										"2": "249"
									},
									{
										"0": "Course",
										"1": "User report",
										"2": "110980"
									},
									{
										"0": "Zoom meeting",
										"1": "System",
										"2": "2878"
									},
									{
										"0": "Forum",
										"1": "System",
										"2": "11906"
									},
									{
										"0": "Wiki",
										"1": "Wiki",
										"2": "6291"
									}
								],
								"schema": [
									{
										"key": "0",
										"name": "split(Event context, :)[0]",
										"type": "string"
									},
									{
										"key": "1",
										"name": "Component",
										"type": "string"
									},
									{
										"key": "2",
										"name": "count",
										"type": "bigint"
									}
								]
							},
							"isSummary": false,
							"language": "scala"
						},
						"persist_state": {
							"view": {
								"type": "details",
								"chartOptions": {
									"chartType": "bar",
									"aggregationType": "sum",
									"categoryFieldKeys": [
										"0"
									],
									"seriesFieldKeys": [
										"2"
									],
									"isStacked": false
								}
							}
						}
					},
					"7979bf43-04da-45dc-9ce3-7caa2a85e040": {
						"type": "Synapse.DataFrame",
						"sync_state": {
							"table": {
								"rows": [
									{
										"0": "Calendar event deleted",
										"1": "1618"
									},
									{
										"0": "Question updated",
										"1": "2724"
									},
									{
										"0": "Capability assigned",
										"1": "84"
									},
									{
										"0": "Course section created",
										"1": "29984"
									},
									{
										"0": "Course viewed",
										"1": "4709468"
									},
									{
										"0": "Badge created",
										"1": "2"
									},
									{
										"0": "Question category moved",
										"1": "35"
									},
									{
										"0": "Grade item created",
										"1": "1815"
									},
									{
										"0": "Role assigned",
										"1": "18119"
									},
									{
										"0": "User graded",
										"1": "244735"
									},
									{
										"0": "Grouping deleted",
										"1": "80"
									},
									{
										"0": "Grade item updated",
										"1": "7380"
									},
									{
										"0": "User unenrolled from course",
										"1": "5347"
									},
									{
										"0": "Questions exported",
										"1": "65"
									},
									{
										"0": "Calendar event updated",
										"1": "52407"
									},
									{
										"0": "Group created",
										"1": "1010"
									},
									{
										"0": "Questions imported",
										"1": "9"
									},
									{
										"0": "Course created",
										"1": "167"
									},
									{
										"0": "Group unassigned from grouping",
										"1": "191"
									},
									{
										"0": "Calendar event created",
										"1": "8300"
									},
									{
										"0": "Group member removed",
										"1": "6584"
									},
									{
										"0": "Question category updated",
										"1": "140"
									},
									{
										"0": "Course module instance list viewed",
										"1": "26"
									},
									{
										"0": "Course summary viewed",
										"1": "38"
									},
									{
										"0": "User list viewed",
										"1": "2184"
									},
									{
										"0": "Grouping updated",
										"1": "10"
									},
									{
										"0": "Question deleted",
										"1": "4635"
									},
									{
										"0": "Capability unassigned",
										"1": "84"
									},
									{
										"0": "Course section updated",
										"1": "31588"
									},
									{
										"0": "Tag added to an item",
										"1": "336"
									},
									{
										"0": "Course backup created",
										"1": "216"
									},
									{
										"0": "Question moved",
										"1": "416"
									},
									{
										"0": "Grade deleted",
										"1": "128717"
									},
									{
										"0": "Group updated",
										"1": "379"
									},
									{
										"0": "Course user report viewed",
										"1": "144"
									},
									{
										"0": "User profile viewed",
										"1": "45406"
									},
									{
										"0": "Group member added",
										"1": "25661"
									},
									{
										"0": "Course content deleted",
										"1": "132"
									},
									{
										"0": "Question category deleted",
										"1": "46"
									},
									{
										"0": "Grouping created",
										"1": "1186"
									},
									{
										"0": "Group deleted",
										"1": "702"
									},
									{
										"0": "Enrolment instance updated",
										"1": "1"
									},
									{
										"0": "Role unassigned",
										"1": "5500"
									},
									{
										"0": "User enrolled in course",
										"1": "17754"
									},
									{
										"0": "Question created",
										"1": "1294"
									},
									{
										"0": "Group assigned to grouping",
										"1": "3574"
									},
									{
										"0": "Question category created",
										"1": "504"
									},
									{
										"0": "Enrolment instance created",
										"1": "845"
									},
									{
										"0": "Course restored",
										"1": "181"
									},
									{
										"0": "Question category viewed",
										"1": "2567"
									},
									{
										"0": "Question viewed",
										"1": "445"
									},
									{
										"0": "Notes viewed",
										"1": "4"
									},
									{
										"0": "Course updated",
										"1": "257"
									}
								],
								"schema": [
									{
										"key": "0",
										"name": "Event name",
										"type": "string"
									},
									{
										"key": "1",
										"name": "count",
										"type": "bigint"
									}
								]
							},
							"isSummary": false,
							"language": "scala"
						},
						"persist_state": {
							"view": {
								"type": "details",
								"chartOptions": {
									"chartType": "bar",
									"aggregationType": "sum",
									"categoryFieldKeys": [
										"0"
									],
									"seriesFieldKeys": [
										"1"
									],
									"isStacked": false
								}
							}
						}
					},
					"62496e7f-0fee-447d-99f9-b7f0ef15e086": {
						"type": "Synapse.DataFrame",
						"sync_state": {
							"table": {
								"rows": [
									{
										"0": "CCXCAGXAB",
										"1": "2005",
										"2": "766"
									},
									{
										"0": "CCXXBXBLX",
										"1": "2005",
										"2": "388"
									},
									{
										"0": "CCBHBX",
										"1": "2014",
										"2": "625"
									},
									{
										"0": "CCXHHDGBD",
										"1": "2025",
										"2": "507"
									},
									{
										"0": "{\"$numberDouble\":\"NaN\"}",
										"1": "1912",
										"2": "219350"
									},
									{
										"0": "CCXHZZGLA",
										"1": "2012",
										"2": "1474"
									},
									{
										"0": "CCXHHHCGA",
										"1": "2025",
										"2": "1221"
									},
									{
										"0": "{\"$numberDouble\":\"NaN\"}",
										"1": "2105",
										"2": "578692"
									},
									{
										"0": "CCXZZXLBZ",
										"1": "2025",
										"2": "405"
									},
									{
										"0": "CCXZDWGZX",
										"1": "1912",
										"2": "901"
									},
									{
										"0": "CCXCAALZH",
										"1": "2005",
										"2": "1055"
									},
									{
										"0": "CXXXBXGZA",
										"1": "1912",
										"2": "1410"
									},
									{
										"0": "CCXHHGLLH",
										"1": "2025",
										"2": "347"
									},
									{
										"0": "CCXHZZGLA",
										"1": "2014",
										"2": "878"
									},
									{
										"0": "CCXHHLALZ",
										"1": "2105",
										"2": "131"
									},
									{
										"0": "{\"$numberDouble\":\"NaN\"}",
										"1": "2025",
										"2": "343010"
									},
									{
										"0": "{\"$numberDouble\":\"NaN\"}",
										"1": "2014",
										"2": "377738"
									},
									{
										"0": "CCXCCDCBH",
										"1": "2005",
										"2": "1957"
									},
									{
										"0": "CCXHHGBZD",
										"1": "2025",
										"2": "1329"
									},
									{
										"0": "CCXHZBCLZ",
										"1": "2014",
										"2": "2"
									},
									{
										"0": "CCXZWZCHX",
										"1": "2025",
										"2": "1969"
									},
									{
										"0": "CCXHZDLWB",
										"1": "2014",
										"2": "724"
									},
									{
										"0": "CCXHHLHHX",
										"1": "2025",
										"2": "394"
									},
									{
										"0": "CCXZWABXW",
										"1": "1912",
										"2": "601"
									},
									{
										"0": "CCXZLWADL",
										"1": "2005",
										"2": "608"
									},
									{
										"0": "CCXHZZGLA",
										"1": "2025",
										"2": "891"
									},
									{
										"0": "CCXHCBGDB",
										"1": "2012",
										"2": "454"
									},
									{
										"0": "WGLDG",
										"1": "2105",
										"2": "1074"
									},
									{
										"0": "{\"$numberDouble\":\"NaN\"}",
										"1": "2012",
										"2": "321680"
									},
									{
										"0": "{\"$numberDouble\":\"NaN\"}",
										"1": "1925",
										"2": "260467"
									},
									{
										"0": "{\"$numberDouble\":\"NaN\"}",
										"1": "2005",
										"2": "299068"
									},
									{
										"0": "CCXHHBHDH",
										"1": "2025",
										"2": "691"
									},
									{
										"0": "LXZZD",
										"1": "1914",
										"2": "1263"
									},
									{
										"0": "CCXHZDGHH",
										"1": "2014",
										"2": "148"
									},
									{
										"0": "CCXHCWXCW",
										"1": "2025",
										"2": "679"
									},
									{
										"0": "XAWXLXLHW",
										"1": "2005",
										"2": "365"
									},
									{
										"0": "{\"$numberDouble\":\"NaN\"}",
										"1": "1914",
										"2": "222512"
									},
									{
										"0": "BHZBD",
										"1": "1905",
										"2": "1737"
									},
									{
										"0": "CCXHHLLZB",
										"1": "2025",
										"2": "925"
									},
									{
										"0": "{\"$numberDouble\":\"NaN\"}",
										"1": "2112",
										"2": "500296"
									},
									{
										"0": "CCXHCAZAD",
										"1": "2025",
										"2": "1081"
									},
									{
										"0": "CCZCCH",
										"1": "2105",
										"2": "793"
									},
									{
										"0": "CCXHXBCAZ",
										"1": "2014",
										"2": "253"
									},
									{
										"0": "CCXZWBLZG",
										"1": "2105",
										"2": "631"
									},
									{
										"0": "CCXZAXAZX",
										"1": "2005",
										"2": "704"
									},
									{
										"0": "CCXZXZLGX",
										"1": "2005",
										"2": "363"
									},
									{
										"0": "CCXCWGXLB",
										"1": "2005",
										"2": "1052"
									},
									{
										"0": "CCXCALWWC",
										"1": "2005",
										"2": "394"
									},
									{
										"0": "CCXZWWZXH",
										"1": "2005",
										"2": "500"
									},
									{
										"0": "{\"$numberDouble\":\"NaN\"}",
										"1": "1905",
										"2": "182089"
									},
									{
										"0": "CCXHZAWCB",
										"1": "2025",
										"2": "1070"
									},
									{
										"0": "CCXZDLHDB",
										"1": "1914",
										"2": "215"
									},
									{
										"0": "CCXHHWAZB",
										"1": "2025",
										"2": "1803"
									},
									{
										"0": "CXXXDHLAX",
										"1": "2005",
										"2": "1844"
									},
									{
										"0": "CXXXHXWHL",
										"1": "2005",
										"2": "554"
									}
								],
								"schema": [
									{
										"key": "0",
										"name": "StudentID",
										"type": "string"
									},
									{
										"key": "1",
										"name": "TermCode",
										"type": "string"
									},
									{
										"key": "2",
										"name": "count",
										"type": "bigint"
									}
								]
							},
							"isSummary": false,
							"language": "scala"
						},
						"persist_state": {
							"view": {
								"type": "details",
								"chartOptions": {
									"chartType": "bar",
									"aggregationType": "sum",
									"categoryFieldKeys": [
										"0"
									],
									"seriesFieldKeys": [
										"2"
									],
									"isStacked": false
								}
							}
						}
					}
				}
			},
			"enableDebugMode": false,
			"kernelspec": {
				"name": "synapse_pyspark",
				"display_name": "Synapse PySpark"
			},
			"language_info": {
				"name": "python"
			},
			"a365ComputeOptions": {
				"id": "/subscriptions/551f35f8-5023-4513-ae40-48f2e9f65fc6/resourceGroups/DUS02mem/providers/Microsoft.Synapse/workspaces/studentanalytics/bigDataPools/batched",
				"name": "batched",
				"type": "Spark",
				"endpoint": "https://studentanalytics.dev.azuresynapse.net/livyApi/versions/2019-11-01-preview/sparkPools/batched",
				"auth": {
					"type": "AAD",
					"authResource": "https://dev.azuresynapse.net"
				},
				"sparkVersion": "2.4",
				"nodeCount": 3,
				"cores": 4,
				"memory": 28,
				"extraHeader": null
			}
		},
		"cells": [
			{
				"cell_type": "code",
				"source": [
					"from pyspark.sql.functions import *\r\n",
					"from pyspark.sql.types import *"
				],
				"attachments": null,
				"execution_count": 1
			},
			{
				"cell_type": "code",
				"metadata": {
					"jupyter": {
						"source_hidden": false,
						"outputs_hidden": false
					},
					"nteract": {
						"transient": {
							"deleting": false
						}
					}
				},
				"source": [
					"logDF = spark.read.load('abfss://datalake@dus02store.dfs.core.windows.net/fromAtlas/NewLog.json', format='json')\r\n",
					"logDF = logDF.filter(logDF.filename != 'NEWLogBUIL 1024 _1094_SP42020.csv')\r\n",
					"logDF = logDF.drop('_id').distinct()"
				],
				"attachments": null,
				"execution_count": 14
			},
			{
				"cell_type": "code",
				"metadata": {
					"jupyter": {
						"source_hidden": false,
						"outputs_hidden": false
					},
					"nteract": {
						"transient": {
							"deleting": false
						}
					}
				},
				"source": [
					"logDF = logDF.withColumn('course', regexp_extract(upper(logDF.filename), r'NEWLOG(LOGS)?_?([A-Z]{4}\\s\\d{4})', 2))\r\n",
					"logDF = logDF.withColumn('StudyPeriod', regexp_extract(upper(logDF.filename), r'NEWLOG(LOGS)?_?([A-Z]{4}\\s\\d{4})\\s?_?(SP\\d{1})', 3))\r\n",
					"logDF = logDF.withColumn('Year', when(col('filename')=='NEWLoglogs_MATH 1077 SP3021_20210925-1114.csv', '2021')\r\n",
					"                                .otherwise(regexp_extract(upper(logDF.filename), r'NEWLOG(LOGS)?_?([A-Z]{4}\\s\\d{4})\\s?_?(SP\\d{1})\\s?(\\d{4})', 4)))\r\n",
					"logDF = logDF.withColumn('TermCode', when(col('StudyPeriod') == 'SP1', concat(substring(col('Year'), 3, 2), lit('05')))\r\n",
					"                                    .when(col('StudyPeriod') == 'SP3', concat(substring(col('Year'), 3, 2), lit('12')))\r\n",
					"                                    .when(col('StudyPeriod') == 'SP4', concat(substring(col('Year'), 3, 2), lit('14')))\r\n",
					"                                    .when(col('StudyPeriod') == 'SP6', concat(substring(col('Year'), 3, 2), lit('25'))))"
				],
				"attachments": null,
				"execution_count": 15
			},
			{
				"cell_type": "code",
				"metadata": {
					"jupyter": {
						"source_hidden": false,
						"outputs_hidden": false
					},
					"nteract": {
						"transient": {
							"deleting": false
						}
					}
				},
				"source": [
					"logDF = logDF.withColumn('TimeFormed', to_timestamp(col('Time'), 'dd/MM/yy, HH:mm'))\r\n",
					"logDF = logDF.withColumn('DateFormed', to_date(logDF.TimeFormed))\r\n",
					"logDF = logDF.filter(logDF.TimeFormed.isNotNull())"
				],
				"attachments": null,
				"execution_count": 16
			},
			{
				"cell_type": "code",
				"metadata": {
					"jupyter": {
						"source_hidden": false,
						"outputs_hidden": false
					},
					"nteract": {
						"transient": {
							"deleting": false
						}
					},
					"collapsed": false
				},
				"source": [
					"display(logDF.filter((col('Component') == 'System') & (split(col('Event context'), ':').getItem(0) == 'Course')).groupBy('Event name').count().collect())"
				],
				"attachments": null,
				"execution_count": 6
			},
			{
				"cell_type": "code",
				"metadata": {
					"jupyter": {
						"source_hidden": false,
						"outputs_hidden": false
					},
					"nteract": {
						"transient": {
							"deleting": false
						}
					},
					"collapsed": false
				},
				"source": [
					"display(logDF.groupBy([split(col('Event context'), ':').getItem(0), col('Component')]).count().collect())"
				],
				"attachments": null,
				"execution_count": 6
			},
			{
				"cell_type": "code",
				"metadata": {
					"jupyter": {
						"source_hidden": false,
						"outputs_hidden": false
					},
					"nteract": {
						"transient": {
							"deleting": false
						}
					}
				},
				"source": [
					"logDF = logDF.withColumn('ActivityResourceType', when(trim(split(col('Event context'), ':').getItem(0)) == 'Other', col('Component'))\r\n",
					"                                                .when(trim(split(col('Event context'), ':').getItem(0)) == 'Course', col('Component'))\r\n",
					"                                                .otherwise(trim(split(col('Event context'), ':').getItem(0))))"
				],
				"attachments": null,
				"execution_count": 17
			},
			{
				"cell_type": "code",
				"metadata": {
					"jupyter": {
						"source_hidden": false,
						"outputs_hidden": false
					},
					"nteract": {
						"transient": {
							"deleting": false
						}
					}
				},
				"source": [
					"logDF = logDF.withColumn('ActivityResourceName', trim(split(col('Event context'), ':').getItem(1)))\r\n",
					"logDF = logDF.withColumn('SubjectArea', trim(split(col('course'), ' ').getItem(0)))\r\n",
					"logDF = logDF.withColumn('CatalogNumber', trim(split(col('course'), ' ').getItem(1)))"
				],
				"attachments": null,
				"execution_count": 18
			},
			{
				"cell_type": "code",
				"metadata": {
					"jupyter": {
						"source_hidden": false,
						"outputs_hidden": false
					},
					"nteract": {
						"transient": {
							"deleting": false
						}
					}
				},
				"source": [
					"DimStudent = spark.sql(\"SELECT * FROM `unisadw`.`dimstudent`\")\r\n",
					"DimDate = spark.sql(\"SELECT * FROM `unisadw`.`dimdate`\")\r\n",
					"DimTime = spark.sql(\"SELECT * FROM `unisadw`.`dimtime`\")\r\n",
					"DimActivity = spark.sql(\"SELECT * FROM `unisadw`.`dimactivity`\")\r\n",
					"DimResource = spark.sql(\"SELECT * FROM `default`.`dimcourseresource`\")"
				],
				"attachments": null,
				"execution_count": 7
			},
			{
				"cell_type": "code",
				"metadata": {
					"jupyter": {
						"source_hidden": false,
						"outputs_hidden": false
					},
					"nteract": {
						"transient": {
							"deleting": false
						}
					}
				},
				"source": [
					"logDF = logDF.withColumn('StudentID', when(col('Student ID').contains('.'), regexp_extract(col('Student ID'), r'(\\w+).', 1))\r\n",
					"                                    .otherwise(col('Student ID')))\r\n",
					"logDF = logDF.withColumnRenamed('Event name', 'ActivityName')"
				],
				"attachments": null,
				"execution_count": 19
			},
			{
				"cell_type": "code",
				"metadata": {
					"jupyter": {
						"source_hidden": false,
						"outputs_hidden": false
					},
					"nteract": {
						"transient": {
							"deleting": false
						}
					}
				},
				"source": [
					"logDF = logDF.join(DimDate, logDF.DateFormed == DimDate.FullDateAlternateKey, 'left')\\\r\n",
					"            .join(DimTime, [hour(logDF.TimeFormed) == DimTime.Hour,\r\n",
					"                            minute(logDF.TimeFormed) == DimTime.Minute,\r\n",
					"                            second(logDF.TimeFormed) == DimTime.Second], 'left')\\\r\n",
					"            .join(DimStudent, [DimStudent.StudentID == logDF.StudentID,\r\n",
					"                                logDF.TermCode >= DimStudent.EffectiveTerm,\r\n",
					"                                logDF.TermCode < DimStudent.ExpiryTerm], 'left')\\\r\n",
					"            .join(DimResource, ['ActivityResourceName', 'ActivityResourceType', 'SubjectArea', 'CatalogNumber', 'TermCode'], 'left')\\\r\n",
					"            .join(DimActivity, 'ActivityName', 'left')\\\r\n",
					"            .select(logDF.TimeFormed.alias('EngageTime'), logDF.StudentID, logDF.TermCode, DimDate.DateKey.alias('EngageDateSK'), DimTime.TimeSK.alias('EngageTimeSK'), \r\n",
					"                    DimStudent.StudentSK, DimResource.ResourceSK, DimActivity.ActivitySK)"
				],
				"attachments": null,
				"execution_count": 21
			},
			{
				"cell_type": "code",
				"metadata": {
					"jupyter": {
						"source_hidden": false,
						"outputs_hidden": false
					},
					"nteract": {
						"transient": {
							"deleting": false
						}
					},
					"collapsed": false
				},
				"source": [
					"display(logDF.filter(isnull(logDF.StudentSK)).groupBy(['StudentID', 'TermCode']).count().collect())"
				],
				"attachments": null,
				"execution_count": 22
			},
			{
				"cell_type": "code",
				"metadata": {
					"jupyter": {
						"source_hidden": false,
						"outputs_hidden": false
					},
					"nteract": {
						"transient": {
							"deleting": false
						}
					}
				},
				"source": [
					"logDF = logDF.drop('StudentID')"
				],
				"attachments": null,
				"execution_count": 11
			},
			{
				"cell_type": "code",
				"metadata": {
					"jupyter": {
						"source_hidden": false,
						"outputs_hidden": false
					},
					"nteract": {
						"transient": {
							"deleting": false
						}
					}
				},
				"source": [
					"logDF.count()"
				],
				"attachments": null,
				"execution_count": 13
			},
			{
				"cell_type": "code",
				"metadata": {
					"jupyter": {
						"source_hidden": false,
						"outputs_hidden": false
					},
					"nteract": {
						"transient": {
							"deleting": false
						}
					}
				},
				"source": [
					"logDF.write.mode(\"overwrite\").saveAsTable(\"unisadw.factlearnonlineengagement\")"
				],
				"attachments": null,
				"execution_count": 12
			},
			{
				"cell_type": "code",
				"metadata": {
					"jupyter": {
						"source_hidden": false,
						"outputs_hidden": false
					},
					"nteract": {
						"transient": {
							"deleting": false
						}
					}
				},
				"source": [
					"DimResource.write.mode(\"overwrite\").saveAsTable(\"unisadw.dimcourseresource\")"
				],
				"attachments": null,
				"execution_count": 16
			}
		]
	}
}